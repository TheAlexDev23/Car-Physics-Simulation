using System.Collections.Generic;
using UnityEngine;

public class MainCarSimulationScript : MonoBehaviour {
    private Rigidbody cmp_rb;
    public void Start() {
        cmp_rb = GetComponent<Rigidbody>();
        cnst_Cdrag = 0.4257f; //TODO: Add explanation to this value
        cnst_Crr   = 12.8f; //TODO: Add explanation to this value
    }

    private GameObject go_WheelsParentGameObject;
    private List<GameObject> go_wheelsGameObjects;
    
    private void GetWheels() {
        go_WheelsParentGameObject = GameObject.Find("Wheels");
        foreach (Transform go in go_WheelsParentGameObject.transform) {
            go_wheelsGameObjects.Add(go.gameObject);
        }
    }


    public void FixedUpdate() {
        SimulatePhyisics();
        SimulateRotation();
    }

    private Vector3 Ftraction; //Traction generated by wheels rolling on the surface
    private Vector3 Fdrag; //Air resistance
    private Vector3 Frr; //Rolling resistance
    private Vector3 Flong; //The total longtitudinal force
    private Vector3 Fbraking; //Braking force
    public float var_EngineForce;
    private float _var_EngineForce;
    private bool var_isBraking; 
    private float cnst_Cdrag; //Air resistance constant
    private float cnst_Crr; //Rolling resisteance constant
    public float cnst_Cbraking; //Braking constant

    private void SimulatePhyisics() {
        var u = transform.forward; 
        var velocity = cmp_rb.velocity;

        //Calculation of forces
        _var_EngineForce = var_EngineForce * Input.GetAxis("Vertical");

        Ftraction = _var_EngineForce * u;
        Fdrag     = -cnst_Cdrag * velocity * velocity.magnitude; 
        Frr       = -cnst_Crr * velocity;

        if(var_isBraking)
            Fbraking  = -u * cnst_Cbraking * Mathf.Clamp(cmp_rb.velocity.magnitude, 0, 1);
        else 
            Fbraking = Vector3.zero;

        
        Flong = Ftraction + Fdrag + Frr + Fbraking;

        cmp_rb.AddForce(Flong);
    }

    private void SimulateRotation() {

    }

    public void Update() {
        if (Input.GetKeyDown(KeyCode.Space)) {
            var_isBraking = true;
            var_EngineForce -= cnst_Cbraking;
        }
        if (Input.GetKeyUp(KeyCode.Space)) {
            var_isBraking = false;
            var_EngineForce += cnst_Cbraking;
        }
    }
}
